<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mes raccourcis - style Opera GX</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Roboto&display=swap');

  body {
    margin: 0; padding: 0;
    background: #121214;
    color: #fff;
    font-family: 'Roboto', sans-serif;
    overflow: hidden;
  }

  #container {
    position: relative;
    width: 100vw; height: 100vh;
    background: linear-gradient(135deg, #1a1a1a 0%, #2a0f1f 100%);
    overflow: hidden;
  }

  /* Login overlay */
  #loginOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(18,18,20,0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    flex-direction: column;
    gap: 20px;
  }
  #loginOverlay h2 {
    font-family: 'Orbitron', sans-serif;
    font-weight: 500;
    font-size: 2.5rem;
    color: #e63946;
    text-shadow: 0 0 10px #e63946aa;
  }
  #loginOverlay input {
    padding: 12px 20px;
    border-radius: 25px;
    border: none;
    width: 280px;
    font-size: 1.2rem;
    outline: none;
    background: #222;
    color: #fff;
    box-shadow: 0 0 10px #e63946bb inset;
    transition: box-shadow 0.3s ease;
  }
  #loginOverlay input:focus {
    box-shadow: 0 0 20px #f94144;
  }
  #loginOverlay button {
    padding: 12px 30px;
    border-radius: 30px;
    border: none;
    background: #e63946;
    color: #fff;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s ease;
    box-shadow: 0 0 15px #e63946cc;
  }
  #loginOverlay button:hover:not(:disabled) {
    background: #f94144;
    box-shadow: 0 0 25px #f94144ee;
  }
  #loginOverlay button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Bouton ajouter */
  #addShortcutBtn {
    position: fixed;
    top: 20px; right: 20px;
    padding: 12px 28px;
    border-radius: 30px;
    border: none;
    background: #e63946;
    color: #fff;
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 0 15px #e63946cc;
    transition: background 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    z-index: 1000;
  }
  #addShortcutBtn:hover {
    background: #f94144;
    box-shadow: 0 0 25px #f94144ee;
  }

  /* Cards */
  .card {
    position: absolute;
    background: #1e1e1e;
    border-radius: 15px;
    box-shadow: 0 0 15px #e63946cc;
    border: 2px solid #e63946;
    padding: 15px 20px;
    color: #fff;
    user-select: none;
    cursor: grab;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: box-shadow 0.3s ease;
    min-width: 140px;
    min-height: 80px;
    overflow: hidden;
  }
  .card:hover {
    box-shadow: 0 0 25px #f94144dd;
  }
  .card a {
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    color: #f94144;
    font-size: 1.2rem;
    text-decoration: none;
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .card a:hover {
    text-decoration: underline;
  }
  .card small {
    color: #bbb;
    font-size: 0.8rem;
    font-family: monospace;
  }
  .resize-handle {
    position: absolute;
    right: 6px; bottom: 6px;
    width: 15px; height: 15px;
    background: #e63946;
    cursor: se-resize;
    border-radius: 3px;
    box-shadow: 0 0 10px #f94144;
  }

  /* Popup */
  #popupOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(18,18,20,0.95);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 11000;
  }
  #popup {
    background: #1f1f1f;
    border: 2px solid #e63946;
    border-radius: 20px;
    padding: 30px 40px;
    width: 360px;
    box-shadow: 0 0 20px #e63946cc;
  }
  #popup h3 {
    font-family: 'Orbitron', sans-serif;
    color: #f94144;
    margin: 0 0 25px 0;
    text-align: center;
    user-select: none;
  }
  #popup input {
    width: 100%;
    padding: 12px 20px;
    border-radius: 15px;
    border: none;
    background: #222;
    color: #fff;
    font-size: 1.1rem;
    outline: none;
    box-shadow: 0 0 12px #e63946bb inset;
    margin-bottom: 20px;
    transition: box-shadow 0.3s ease;
  }
  #popup input:focus {
    box-shadow: 0 0 25px #f94144;
  }
  #popup button {
    padding: 12px 30px;
    border-radius: 30px;
    border: none;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    margin-right: 15px;
    box-shadow: 0 0 15px #e63946cc;
    transition: background 0.3s ease;
  }
  #saveBtn {
    background: #e63946;
    color: white;
  }
  #saveBtn:hover {
    background: #f94144;
  }
  #cancelBtn {
    background: #444;
    color: #ccc;
  }
  #cancelBtn:hover {
    background: #666;
  }
</style>
</head>
<body>

<div id="container"></div>

<button id="addShortcutBtn">+ Ajouter un raccourci</button>

<!-- Login overlay -->
<div id="loginOverlay">
  <h2>Bienvenue !</h2>
  <input id="loginInput" placeholder="Entrez votre pseudo" maxlength="20" />
  <button id="loginBtn" disabled>Connexion</button>
</div>

<!-- Popup ajout/modif -->
<div id="popupOverlay">
  <div id="popup">
    <h3 id="popupTitle">Ajouter un raccourci</h3>
    <input type="text" id="siteNameInput" placeholder="Nom du site" maxlength="30" />
    <input type="url" id="siteURLInput" placeholder="URL complète (ex: https://...)" />
    <div style="text-align:center; margin-top: 10px;">
      <button id="saveBtn">Enregistrer</button>
      <button id="cancelBtn">Annuler</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
    authDomain: "kylita-f2923.firebaseapp.com",
    databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
    projectId: "kylita-f2923",
    storageBucket: "kylita-f2923.firebasestorage.app",
    messagingSenderId: "431823530994",
    appId: "1:431823530994:web:88a07e633751686e5ad96b",
    measurementId: "G-F4LLNWQJ16"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const loginOverlay = document.getElementById('loginOverlay');
  const loginInput = document.getElementById('loginInput');
  const loginBtn = document.getElementById('loginBtn');

  const container = document.getElementById('container');
  const addShortcutBtn = document.getElementById('addShortcutBtn');
  const popupOverlay = document.getElementById('popupOverlay');
  const popupTitle = document.getElementById('popupTitle');
  const siteNameInput = document.getElementById('siteNameInput');
  const siteURLInput = document.getElementById('siteURLInput');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  let currentUser = null;
  let currentEditingId = null; // null = new shortcut; sinon modif

  // Activer bouton connexion si pseudo >= 3 chars
  loginInput.addEventListener('input', () => {
    loginBtn.disabled = loginInput.value.trim().length < 3;
  });

  // Connexion Firebase anonyme + mise à jour displayName avec pseudo
  loginBtn.addEventListener('click', async () => {
    const pseudo = loginInput.value.trim();
    if (pseudo.length < 3) return;
    try {
      // Connexion anonyme Firebase
      let userCredential = await auth.signInAnonymously();

      // On update displayName via updateProfile (Firebase v9 compat)
      await userCredential.user.updateProfile({ displayName: pseudo });

      currentUser = userCredential.user;

      // Masquer login
      loginOverlay.style.display = 'none';

      // Charger raccourcis
      loadShortcuts();

    } catch (e) {
      alert('Erreur connexion Firebase : ' + e.message);
      console.error(e);
    }
  });

  // Charger les raccourcis depuis Firebase et afficher
  function loadShortcuts() {
    if (!currentUser) return;
    const shortcutsRef = db.ref(`accounts/${currentUser.uid}/shortcuts`);

    shortcutsRef.on('value', (snapshot) => {
      container.innerHTML = ''; // clear

      const data = snapshot.val() || {};

      Object.entries(data).forEach(([id, shortcut]) => {
        createShortcutCard(id, shortcut);
      });
    });
  }

  // Créer une carte raccourci sur la page
  function createShortcutCard(id, { name, url, x=50, y=50, w=160, h=90 }) {
    const card = document.createElement('div');
    card.classList.add('card');
    card.style.left = x + 'px';
    card.style.top = y + 'px';
    card.style.width = w + 'px';
    card.style.height = h + 'px';
    card.setAttribute('data-id', id);

    // Lien vers site
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = name;
    card.appendChild(a);

    // URL en petit
    const small = document.createElement('small');
    small.textContent = url;
    card.appendChild(small);

    // Resize handle
    const resizeHandle = document.createElement('div');
    resizeHandle.classList.add('resize-handle');
    card.appendChild(resizeHandle);

    // Drag & Drop
    dragElement(card);

    // Resize
    makeResizable(card, resizeHandle);

    // Click sur carte ouvre popup modif
    card.addEventListener('dblclick', () => {
      openPopupForEdit(id, { name, url, x, y, w, h });
    });

    container.appendChild(card);
  }

  // Ouvrir popup ajout/modif
  function openPopupForEdit(id=null, data=null) {
    currentEditingId = id;
    if (id) {
      popupTitle.textContent = 'Modifier le raccourci';
      siteNameInput.value = data.name;
      siteURLInput.value = data.url;
    } else {
      popupTitle.textContent = 'Ajouter un raccourci';
      siteNameInput.value = '';
      siteURLInput.value = '';
    }
    popupOverlay.style.display = 'flex';
    siteNameInput.focus();
  }

  // Fermer popup
  cancelBtn.addEventListener('click', () => {
    popupOverlay.style.display = 'none';
    currentEditingId = null;
  });

  // Enregistrer raccourci
  saveBtn.addEventListener('click', async () => {
    const name = siteNameInput.value.trim();
    const url = siteURLInput.value.trim();

    if (name.length < 1 || !url.match(/^https?:\/\/.+/i)) {
      alert('Veuillez entrer un nom et une URL valide (commençant par http:// ou https://)');
      return;
    }
    if (!currentUser) {
      alert('Non connecté');
      return;
    }

    // Si modif ou ajout
    const shortcutsRef = db.ref(`accounts/${currentUser.uid}/shortcuts`);
    if (currentEditingId) {
      // Récup les positions/tailles actuelles
      const card = container.querySelector(`[data-id="${currentEditingId}"]`);
      if (!card) return alert('Carte non trouvée');

      const x = parseInt(card.style.left, 10) || 50;
      const y = parseInt(card.style.top, 10) || 50;
      const w = parseInt(card.style.width, 10) || 160;
      const h = parseInt(card.style.height, 10) || 90;

      await shortcutsRef.child(currentEditingId).set({ name, url, x, y, w, h });
    } else {
      // Ajout avec position par défaut centre
      await shortcutsRef.push({ name, url, x: 50, y: 50, w: 160, h: 90 });
    }

    popupOverlay.style.display = 'none';
    currentEditingId = null;
  });

  // Déplacer la carte
  function dragElement(elmnt) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    elmnt.style.cursor = 'grab';

    elmnt.onpointerdown = dragMouseDown;

    function dragMouseDown(e) {
      if (e.target.classList.contains('resize-handle')) return; // ne pas drag si resize
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onpointermove = elementDrag;
      document.onpointerup = closeDragElement;
      elmnt.style.cursor = 'grabbing';
    }

    function elementDrag(e) {
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      let newX = elmnt.offsetLeft - pos1;
      let newY = elmnt.offsetTop - pos2;

      // Limiter à l'intérieur de container
      const maxX = container.clientWidth - elmnt.clientWidth;
      const maxY = container.clientHeight - elmnt.clientHeight;
      newX = Math.max(0, Math.min(newX, maxX));
      newY = Math.max(0, Math.min(newY, maxY));

      elmnt.style.left = newX + "px";
      elmnt.style.top = newY + "px";
    }

    function closeDragElement() {
      document.onpointerup = null;
      document.onpointermove = null;
      elmnt.style.cursor = 'grab';

      // Save position in Firebase
      if (!currentUser) return;
      const id = elmnt.getAttribute('data-id');
      if (!id) return;

      const shortcutsRef = db.ref(`accounts/${currentUser.uid}/shortcuts/${id}`);

      shortcutsRef.once('value').then(snap => {
        const data = snap.val() || {};
        shortcutsRef.update({
          x: parseInt(elmnt.style.left,10),
          y: parseInt(elmnt.style.top,10),
          w: data.w || elmnt.clientWidth,
          h: data.h || elmnt.clientHeight,
        });
      });
    }
  }

  // Resize carte
  function makeResizable(elmnt, handle) {
    let startX, startY, startWidth, startHeight;

    handle.onpointerdown = function(e) {
      e.preventDefault();
      startX = e.clientX;
      startY = e.clientY;
      startWidth = parseInt(document.defaultView.getComputedStyle(elmnt).width, 10);
      startHeight = parseInt(document.defaultView.getComputedStyle(elmnt).height, 10);
      document.onpointermove = doDrag;
      document.onpointerup = stopDrag;
      document.body.style.userSelect = 'none';
      elmnt.style.cursor = 'se-resize';
    };

    function doDrag(e) {
      let newWidth = startWidth + e.clientX - startX;
      let newHeight = startHeight + e.clientY - startY;

      // Limiter taille
      newWidth = Math.max(80, Math.min(newWidth, container.clientWidth - elmnt.offsetLeft));
      newHeight = Math.max(40, Math.min(newHeight, container.clientHeight - elmnt.offsetTop));

      elmnt.style.width = newWidth + 'px';
      elmnt.style.height = newHeight + 'px';
    }

    function stopDrag(e) {
      document.onpointermove = null;
      document.onpointerup = null;
      document.body.style.userSelect = '';
      elmnt.style.cursor = 'grab';

      // Save size in Firebase
      if (!currentUser) return;
      const id = elmnt.getAttribute('data-id');
      if (!id) return;
      const shortcutsRef = db.ref(`accounts/${currentUser.uid}/shortcuts/${id}`);

      shortcutsRef.once('value').then(snap => {
        const data = snap.val() || {};
        shortcutsRef.update({
          x: data.x || elmnt.offsetLeft,
          y: data.y || elmnt.offsetTop,
          w: parseInt(elmnt.style.width,10),
          h: parseInt(elmnt.style.height,10),
        });
      });
    }
  }

  // Ajouter raccourci (popup)
  addShortcutBtn.addEventListener('click', () => {
    openPopupForEdit();
  });
</script>

</body>
</html>
